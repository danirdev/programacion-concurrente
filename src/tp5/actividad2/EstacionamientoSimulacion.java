package tp5.actividad2;

import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

/**
 * Clase principal que simula el funcionamiento de un estacionamiento usando interfaz Runnable.
 * Coordina la generaci√≥n de 100 autom√≥viles y su flujo a trav√©s de un estacionamiento
 * con capacidad para 20 veh√≠culos, 2 entradas y 2 salidas.
 */
public class EstacionamientoSimulacion {
    
    public static void main(String[] args) {
        DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("HH:mm:ss");
        String tiempo = LocalTime.now().format(timeFormatter);
        
        System.out.println("=".repeat(80));
        System.out.println("        SIMULACI√ìN DE ESTACIONAMIENTO CON INTERFAZ RUNNABLE");
        System.out.println("=".repeat(80));
        System.out.println("[" + tiempo + "] Iniciando simulaci√≥n de estacionamiento...");
        System.out.println();
        System.out.println("CONFIGURACI√ìN DEL SISTEMA:");
        System.out.println("‚Ä¢ Implementaci√≥n: Interfaz Runnable");
        System.out.println("‚Ä¢ Capacidad m√°xima: 20 autom√≥viles simult√°neos");
        System.out.println("‚Ä¢ Puntos de acceso: 2 entradas + 2 salidas");
        System.out.println("‚Ä¢ Total de autom√≥viles: 100");
        System.out.println("‚Ä¢ Estado inicial: Estacionamiento vac√≠o");
        System.out.println("‚Ä¢ Llegadas: 300-1000ms entre autom√≥viles");
        System.out.println("‚Ä¢ Permanencia: 2000-8000ms por autom√≥vil");
        System.out.println("=".repeat(80));
        System.out.println();
        
        // Crear el estacionamiento compartido
        Estacionamiento estacionamiento = new Estacionamiento();
        System.out.println("‚úÖ Estacionamiento creado: " + estacionamiento.getInfoResumida());
        
        // Crear el generador de autom√≥viles
        GeneradorAutomoviles generadorAutomoviles = new GeneradorAutomoviles(estacionamiento);
        
        // Crear hilo para mostrar estad√≠sticas peri√≥dicas
        Runnable monitorEstadisticas = () -> {
            try {
                while (!Thread.currentThread().isInterrupted()) {
                    Thread.sleep(10000); // Cada 10 segundos
                    estacionamiento.mostrarEstado();
                    System.out.println("Generador: " + generadorAutomoviles.getInfo());
                    
                    // Mostrar estad√≠sticas de autom√≥viles cada 20 segundos
                    if (System.currentTimeMillis() % 20000 < 10000) {
                        mostrarEstadisticasIntermedia(generadorAutomoviles);
                    }
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        };
        
        Thread hiloMonitor = new Thread(monitorEstadisticas, "Monitor-Estadisticas-Estacionamiento");
        
        try {
            // Iniciar la simulaci√≥n
            tiempo = LocalTime.now().format(timeFormatter);
            System.out.println("[" + tiempo + "] === ESTACIONAMIENTO ABIERTO ===");
            System.out.println("üöÄ Iniciando generaci√≥n de autom√≥viles...");
            
            // Iniciar el generador de autom√≥viles
            Thread hiloGenerador = generadorAutomoviles.iniciarEnHilo();
            System.out.println("   ‚úÖ " + hiloGenerador.getName() + " iniciado");
            
            // Iniciar monitor de estad√≠sticas
            hiloMonitor.start();
            System.out.println("   ‚úÖ " + hiloMonitor.getName() + " iniciado");
            
            System.out.println();
            System.out.println("=".repeat(50));
            System.out.println("     SIMULACI√ìN EN PROGRESO");
            System.out.println("=".repeat(50));
            
            // Esperar a que se generen todos los autom√≥viles
            hiloGenerador.join();
            
            tiempo = LocalTime.now().format(timeFormatter);
            System.out.println();
            System.out.println("[" + tiempo + "] üèÅ GENERACI√ìN COMPLETADA");
            System.out.println("Esperando que todos los autom√≥viles completen sus ciclos...");
            
            // Dar tiempo adicional para que los autom√≥viles terminen
            Thread.sleep(15000); // 15 segundos adicionales
            
            // Detener el monitor
            hiloMonitor.interrupt();
            hiloMonitor.join(2000);
            
            // Esperar a que terminen todos los autom√≥viles
            generadorAutomoviles.esperarAutomoviles();
            
            // Mostrar estad√≠sticas finales
            mostrarEstadisticasFinales(estacionamiento, generadorAutomoviles);
            
            // Demostrar ventajas espec√≠ficas de Runnable
            demostrarVentajasRunnable(generadorAutomoviles);
            
        } catch (InterruptedException e) {
            System.out.println("‚ùå Simulaci√≥n interrumpida");
            Thread.currentThread().interrupt();
        } finally {
            // Asegurar limpieza
            generadorAutomoviles.detener();
            if (hiloMonitor.isAlive()) {
                hiloMonitor.interrupt();
            }
        }
    }
    
    /**
     * Muestra estad√≠sticas intermedias durante la simulaci√≥n
     */
    private static void mostrarEstadisticasIntermedia(GeneradorAutomoviles generador) {
        int[] stats = generador.getEstadisticasAutomoviles();
        int[] accesos = generador.getEstadisticasAccesos();
        
        System.out.println("üìä ESTAD√çSTICAS INTERMEDIAS:");
        System.out.println("   Autom√≥viles completados: " + stats[0]);
        System.out.println("   En proceso: " + stats[1]);
        System.out.println("   Uso de entradas: E1=" + accesos[0] + ", E2=" + accesos[1]);
        System.out.println("   Uso de salidas: S1=" + accesos[2] + ", S2=" + accesos[3]);
    }
    
    /**
     * Muestra las estad√≠sticas finales de la simulaci√≥n
     */
    private static void mostrarEstadisticasFinales(Estacionamiento estacionamiento, 
                                                  GeneradorAutomoviles generadorAutomoviles) {
        DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("HH:mm:ss");
        String tiempo = LocalTime.now().format(timeFormatter);
        
        System.out.println();
        System.out.println("=".repeat(80));
        System.out.println("           ESTAD√çSTICAS FINALES DEL ESTACIONAMIENTO");
        System.out.println("=".repeat(80));
        System.out.println("[" + tiempo + "] Simulaci√≥n completada");
        System.out.println();
        
        // Estad√≠sticas del estacionamiento
        double[] statsEstacionamiento = estacionamiento.getEstadisticas();
        System.out.println("üÖøÔ∏è ESTAD√çSTICAS DEL ESTACIONAMIENTO:");
        System.out.println("   Capacidad m√°xima: " + estacionamiento.getCapacidadMaxima());
        System.out.println("   Ocupaci√≥n final: " + (int)statsEstacionamiento[0] + "/" + 
                          estacionamiento.getCapacidadMaxima());
        System.out.println("   Total entradas: " + (int)statsEstacionamiento[1]);
        System.out.println("   Total salidas: " + (int)statsEstacionamiento[2]);
        System.out.println("   Autom√≥viles esperando: " + (int)statsEstacionamiento[3]);
        System.out.println("   Ocupaci√≥n m√°xima alcanzada: " + String.format("%.1f%%", statsEstacionamiento[4]));
        System.out.println("   Balance (E-S): " + ((int)statsEstacionamiento[1] - (int)statsEstacionamiento[2]));
        System.out.println();
        
        // Estad√≠sticas de autom√≥viles
        int[] estadisticasAutos = generadorAutomoviles.getEstadisticasAutomoviles();
        int totalGenerados = generadorAutomoviles.getAutomovilesGenerados();
        int completaron = estadisticasAutos[0];
        int enProceso = estadisticasAutos[1];
        int noIniciados = estadisticasAutos[2];
        int detenidos = estadisticasAutos[3];
        
        System.out.println("üöó ESTAD√çSTICAS DE AUTOM√ìVILES:");
        System.out.println("   Objetivo: " + generadorAutomoviles.getTotalAutomoviles());
        System.out.println("   Generados: " + totalGenerados);
        System.out.println("   Completaron ciclo: " + completaron);
        System.out.println("   En proceso: " + enProceso);
        System.out.println("   No iniciados: " + noIniciados);
        System.out.println("   Detenidos: " + detenidos);
        System.out.println("   Tasa de finalizaci√≥n: " + 
                          String.format("%.1f%%", (double)completaron / totalGenerados * 100));
        System.out.println();
        
        // Estad√≠sticas de uso de accesos
        int[] estadisticasAccesos = generadorAutomoviles.getEstadisticasAccesos();
        System.out.println("üö™ ESTAD√çSTICAS DE ACCESOS:");
        System.out.println("   Entrada 1: " + estadisticasAccesos[0] + " autom√≥viles (" + 
                          String.format("%.1f%%", (double)estadisticasAccesos[0] / totalGenerados * 100) + ")");
        System.out.println("   Entrada 2: " + estadisticasAccesos[1] + " autom√≥viles (" + 
                          String.format("%.1f%%", (double)estadisticasAccesos[1] / totalGenerados * 100) + ")");
        System.out.println("   Salida 1: " + estadisticasAccesos[2] + " autom√≥viles (" + 
                          String.format("%.1f%%", (double)estadisticasAccesos[2] / totalGenerados * 100) + ")");
        System.out.println("   Salida 2: " + estadisticasAccesos[3] + " autom√≥viles (" + 
                          String.format("%.1f%%", (double)estadisticasAccesos[3] / totalGenerados * 100) + ")");
        
        // Verificar balanceamiento
        double desbalanceEntradas = Math.abs(estadisticasAccesos[0] - estadisticasAccesos[1]);
        double desbalanceSalidas = Math.abs(estadisticasAccesos[2] - estadisticasAccesos[3]);
        System.out.println("   Balanceamiento entradas: " + 
                          (desbalanceEntradas <= totalGenerados * 0.1 ? "‚úÖ Bueno" : "‚ö†Ô∏è Desbalanceado"));
        System.out.println("   Balanceamiento salidas: " + 
                          (desbalanceSalidas <= totalGenerados * 0.1 ? "‚úÖ Bueno" : "‚ö†Ô∏è Desbalanceado"));
        System.out.println();
        
        // Estad√≠sticas de tiempos
        double[] estadisticasTiempos = generadorAutomoviles.getEstadisticasTiempos();
        if (estadisticasTiempos[0] > 0) {
            System.out.println("‚è±Ô∏è ESTAD√çSTICAS DE TIEMPOS:");
            System.out.println("   Tiempo promedio total: " + String.format("%.0f", estadisticasTiempos[0]) + "ms");
            System.out.println("   Tiempo promedio espera: " + String.format("%.0f", estadisticasTiempos[1]) + "ms");
            System.out.println("   Tiempo promedio permanencia: " + String.format("%.0f", estadisticasTiempos[2]) + "ms");
            
            // An√°lisis de eficiencia
            double porcentajeEspera = (estadisticasTiempos[1] / estadisticasTiempos[0]) * 100;
            System.out.println("   % Tiempo esperando: " + String.format("%.1f%%", porcentajeEspera));
            
            if (porcentajeEspera > 30) {
                System.out.println("   ‚ö†Ô∏è Alto tiempo de espera - Considerar m√°s entradas");
            } else if (porcentajeEspera < 10) {
                System.out.println("   ‚úÖ Bajo tiempo de espera - Sistema eficiente");
            } else {
                System.out.println("   ‚úÖ Tiempo de espera aceptable");
            }
            System.out.println();
        }
        
        // An√°lisis de rendimiento
        System.out.println("‚ö° AN√ÅLISIS DE RENDIMIENTO:");
        double tasaEntrada = (double)estadisticasAutos[1] / 60.0; // Asumiendo 1 minuto de simulaci√≥n
        double capacidadTeorica = 20.0; // Capacidad m√°xima
        double utilizacion = ((double)statsEstacionamiento[0] / capacidadTeorica) * 100;
        
        System.out.println("   Utilizaci√≥n final: " + String.format("%.1f%%", utilizacion));
        System.out.println("   Eficiencia del sistema: " + 
                          (completaron >= totalGenerados * 0.9 ? "‚úÖ Alta" : 
                           completaron >= totalGenerados * 0.7 ? "‚ö†Ô∏è Media" : "‚ùå Baja"));
        
        if (estacionamiento.estaVacio()) {
            System.out.println("   ‚úÖ Estacionamiento vac√≠o al final");
        } else {
            System.out.println("   ‚ö†Ô∏è " + estacionamiento.getAutomovilesActuales() + 
                             " autom√≥viles a√∫n en el estacionamiento");
        }
    }
    
    /**
     * Demuestra las ventajas espec√≠ficas de usar Runnable vs Thread
     */
    private static void demostrarVentajasRunnable(GeneradorAutomoviles generador) {
        System.out.println();
        System.out.println("=".repeat(80));
        System.out.println("        VENTAJAS DE RUNNABLE DEMOSTRADAS EN ESTACIONAMIENTO");
        System.out.println("=".repeat(80));
        
        System.out.println("\nüéØ 1. GESTI√ìN MASIVA DE HILOS:");
        System.out.println("   ‚úÖ Generaci√≥n din√°mica de " + generador.getAutomovilesGenerados() + " hilos de autom√≥viles");
        System.out.println("   ‚úÖ Control centralizado de todos los hilos desde el generador");
        System.out.println("   ‚úÖ Gesti√≥n eficiente de recursos del sistema");
        
        System.out.println("\nüîÑ 2. FLEXIBILIDAD DE IMPLEMENTACI√ìN:");
        System.out.println("   ‚úÖ Separaci√≥n clara entre l√≥gica de negocio y gesti√≥n de hilos");
        System.out.println("   ‚úÖ Autom√≥viles como tareas reutilizables");
        System.out.println("   ‚úÖ F√°cil integraci√≥n con pools de hilos si fuera necesario");
        
        System.out.println("\nüéõÔ∏è 3. CONTROL GRANULAR:");
        System.out.println("   ‚úÖ M√©todo detener() personalizado para parada controlada");
        System.out.println("   ‚úÖ Estados independientes del ciclo de vida del hilo");
        System.out.println("   ‚úÖ Informaci√≥n detallada de cada autom√≥vil");
        
        // Demostrar informaci√≥n detallada
        int hilosVivos = (int) generador.getHilosAutomoviles().stream().filter(Thread::isAlive).count();
        System.out.println("\nüìä 4. MONITOREO AVANZADO:");
        System.out.println("   ‚úÖ Hilos a√∫n vivos: " + hilosVivos + "/" + generador.getAutomovilesGenerados());
        System.out.println("   ‚úÖ Estad√≠sticas detalladas por autom√≥vil");
        System.out.println("   ‚úÖ Seguimiento de uso de entradas/salidas");
        
        System.out.println("\nüß™ 5. TESTABILIDAD MEJORADA:");
        System.out.println("   ‚úÖ L√≥gica de autom√≥viles testeable sin hilos reales");
        System.out.println("   ‚úÖ Simulaci√≥n de estacionamiento sin concurrencia para tests");
        System.out.println("   ‚úÖ Mocking sencillo de dependencias");
        
        System.out.println("\n‚ö° 6. ESCALABILIDAD:");
        System.out.println("   ‚úÖ Preparado para ExecutorService y pools de hilos");
        System.out.println("   ‚úÖ Manejo eficiente de gran cantidad de tareas concurrentes");
        System.out.println("   ‚úÖ Mejor gesti√≥n de memoria y recursos del SO");
        
        System.out.println("\nüèóÔ∏è 7. ARQUITECTURA LIMPIA:");
        System.out.println("   ‚úÖ Responsabilidades bien definidas por clase");
        System.out.println("   ‚úÖ Bajo acoplamiento entre componentes");
        System.out.println("   ‚úÖ F√°cil mantenimiento y extensi√≥n");
        
        System.out.println("\nüìà 8. COMPARACI√ìN CON HERENCIA DE THREAD:");
        System.out.println("   Flexibilidad:     Thread ‚≠ê‚≠ê‚≠ê vs Runnable ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê");
        System.out.println("   Gesti√≥n masiva:   Thread ‚≠ê‚≠ê   vs Runnable ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê");
        System.out.println("   Reutilizaci√≥n:    Thread ‚≠ê‚≠ê   vs Runnable ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê");
        System.out.println("   Testabilidad:     Thread ‚≠ê‚≠ê‚≠ê vs Runnable ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê");
        System.out.println("   Escalabilidad:    Thread ‚≠ê‚≠ê‚≠ê vs Runnable ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê");
        
        System.out.println("\n" + "=".repeat(80));
        System.out.println("üèÜ CONCLUSI√ìN: Para sistemas con muchos hilos concurrentes como este");
        System.out.println("   estacionamiento, Runnable ofrece ventajas significativas en gesti√≥n,");
        System.out.println("   escalabilidad y mantenibilidad del c√≥digo.");
        System.out.println("=".repeat(80));
    }
}
